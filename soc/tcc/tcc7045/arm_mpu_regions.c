/* SPDX-License-Identifier: Apache-2.0
 *
 * Copyright 2024 Hounjoung Rim <hounjoung@tsnlab.com>
 */

#include <zephyr/kernel.h>
#include <zephyr/arch/arm/mpu/arm_mpu.h>

#define MPU_SHAREABLE             (0x00000004U)
#define MPU_STRONG_ORDERED_SHARED (0x00000000U)

#define MPU_DEVICE_SHARED    (0x00000001U)
#define MPU_DEVICE_NONSHARED (0x00000010U)

#define MPU_NORM_NSHARED_WT_NWA (0x00000002U)
#define MPU_NORM_SHARED_WT_NWA  (0x00000006U)

#define MPU_NORM_NSHARED_WB_NWA (0x00000003U)
#define MPU_NORM_SHARED_WB_NWA  (0x00000007U)

#define MPU_NORM_NSHARED_NCACHE (0x00000008U)
#define MPU_NORM_SHARED_NCACHE  (0x0000000CU)

#define MPU_NORM_NSHARED_WB_WA (0x0000000BU)
#define MPU_NORM_SHARED_WB_WA  (0x0000000FU)

#define MPU_NO_ACCESS       (0x00000000U << 8U)
#define MPU_PRIV_RW_USER_NA (0x00000001U << 8U)
#define MPU_PRIV_RW_USER_RO (0x00000002U << 8U)
#define MPU_PRIV_RW_USER_RW (0x00000003U << 8U)
#define MPU_PRIV_RO_USER_NA (0x00000005U << 8U)
#define MPU_PRIV_RO_USER_RO (0x00000006U << 8U)

extern uint32_t _image_rom_end_order;
static const struct arm_mpu_region mpu_regions[] = {
	MPU_REGION_ENTRY("SRAM0", 0x00000000, REGION_512K,
			 {.rasr = (MPU_NORM_SHARED_WB_WA | MPU_PRIV_RW_USER_RW)}),

	MPU_REGION_ENTRY("REMAP_FLASH", 0x01000000, REGION_4M,
			 {.rasr = MPU_NORM_NSHARED_WB_NWA | MPU_PRIV_RO_USER_RO}),

	MPU_REGION_ENTRY("PFLASH", 0x20000000, REGION_2M,
			 {.rasr = MPU_NORM_NSHARED_WB_NWA | MPU_PRIV_RO_USER_RO}),

	MPU_REGION_ENTRY("DFLASH", 0x30000000, REGION_256K,
			 {.rasr = MPU_NORM_NSHARED_WB_NWA | MPU_PRIV_RW_USER_RW}),

	MPU_REGION_ENTRY("SNOR", 0x40000000, REGION_256M,
			 {.rasr = MPU_NORM_NSHARED_NCACHE | MPU_PRIV_RO_USER_RO}),

	MPU_REGION_ENTRY("PERI", 0xA0000000, REGION_16M,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RW}),

	MPU_REGION_ENTRY("PFLASHCON", 0xA1000000, REGION_64K,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RW}),

	MPU_REGION_ENTRY("PFLASH_OPTAREA", 0xA1010000, REGION_16K,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RO}),

	MPU_REGION_ENTRY("PFLASH_INT", 0xA1020000, REGION_32B,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RW}),

	MPU_REGION_ENTRY("DFLASHCON", 0xA1080000, REGION_64K,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RW}),

	MPU_REGION_ENTRY("DFLASH_OPTAREA", 0xA1090000, REGION_2K,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RO}),

	MPU_REGION_ENTRY("DFLASH_INT", 0xA10A0000, REGION_64B,
			 {.rasr = MPU_STRONG_ORDERED_SHARED | MPU_PRIV_RW_USER_RW}),
};

const struct arm_mpu_config mpu_config = {
	.num_regions = ARRAY_SIZE(mpu_regions),
	.mpu_regions = mpu_regions,
};
