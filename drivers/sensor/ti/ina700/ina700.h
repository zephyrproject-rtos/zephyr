/*
 * Copyright (c) 2024 Esco Medical ApS
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#ifndef ZEPHYR_DRIVERS_SENSOR_INA700_H_
#define ZEPHYR_DRIVERS_SENSOR_INA700_H_

#include <zephyr/drivers/gpio.h>
#include <zephyr/drivers/i2c.h>
#include <zephyr/drivers/sensor.h>
#include <zephyr/types.h>

struct ina700_config {
	struct i2c_dt_spec bus;
	uint8_t mode;
	uint8_t vbus_conv_time;
	uint8_t shunt_voltage_conv_time;
	uint8_t temperature_conv_time;
	uint8_t sample_averaging_count;
#ifdef CONFIG_INA700_TRIGGER
	const struct gpio_dt_spec alert_gpio;
#endif
};

struct ina700_data {
	int16_t current;
	uint16_t voltage;
	uint32_t power;
	int16_t temperature;
#ifdef CONFIG_INA700_TRIGGER
	const struct device *this;
	const struct device *gpio;
	struct gpio_callback gpio_cb;
	sensor_trigger_handler_t handler_alert;
	const struct sensor_trigger *trigger_alert;
	struct k_work work;
	struct k_mutex mutex;
#endif
};

#define INA700_REG_CONFIG					0x00
#define INA700_REG_ADC_CONFIG					0x01
#define INA700_REG_VBUS						0x05
#define INA700_REG_DIE_TEMPERATURE				0x06
#define INA700_REG_CURRENT					0x07
#define INA700_REG_POWER					0x08
#define INA700_REG_ENERGY					0x09
#define INA700_REG_CHARGE					0x0A
#define INA700_REG_ALERT_DIAGNOSTICS				0x0B
#define INA700_REG_CURRENT_OVER_LIMIT_THRESHOLD			0x0C
#define INA700_REG_CURRENT_UNDER_LIMIT_THRESHOLD		0x0D
#define INA700_REG_BUS_OVERVOLTAGE_THRESHOLD			0x0E
#define INA700_REG_BUS_UNDERVOLTAGE_THRESHOLD			0x0F
#define INA700_REG_TEMPERATURE_OVER_LIMIT			0x10
#define INA700_REG_POWER_OVER_LIMIT				0x11
#define INA700_REG_MANUFACTURER_ID				0x3E

#define INA700_CONFIG_RESET					BIT(15)
#define INA700_CONFIG_RESET_ACCUMULATORS			BIT(14)
#define INA700_CONFIG_CONVERSION_DELAY				GENMASK(13, 6)

#define INA700_CONFIG_RESET_NORMAL_OPERATION			0x00
#define INA700_CONFIG_RESET_SYSTEM_RESET			0x01

#define INA700_CONFIG_ADC_DELAY_0_S				0x00
#define INA700_CONFIG_ADC_DELAY_2_MS				0x01
#define INA700_CONFIG_ADC_DELAY_510_MS				0xFF

#define INA700_ADC_CONFIG_MODE					GENMASK(15, 12)
#define INA700_ADC_CONFIG_VBUS_CONVERSION_TIME			GENMASK(11, 9)
#define INA700_ADC_CONFIG_SHUNT_VOLTAGE_CONVERSION_TIME		GENMASK(8, 6)
#define INA700_ADC_CONFIG_TEMPERATURE_CONVERSION_TIME		GENMASK(5, 3)
#define INA700_ADC_CONFIG_SAMPLE_AVERAGING_COUNT		GENMASK(2, 0)

#define INA700_ADC_MODE_SHUTDOWN				0x00
#define INA700_ADC_MODE_SS_VOLTAGE				0x01
#define INA700_ADC_MODE_SS_TEMP					0x04
#define INA700_ADC_MODE_SS_TEMP_VOLTAGE				0x05
#define INA700_ADC_MODE_SS_TEMP_CURRENT				0x06
#define INA700_ADC_MODE_SS_TEMP_CURRENT_VOLTAGE			0x07
#define INA700_ADC_MODE_CONT_VOLTAGE				0x09
#define INA700_ADC_MODE_CONT_TEMP				0x0C
#define INA700_ADC_MODE_CONT_TEMP_VOLTAGE			0x0D
#define INA700_ADC_MODE_CONT_TEMP_CURRENT			0x0E
#define INA700_ADC_MODE_CONT_TEMP_CURRENT_VOLTAGE		0x0F

#define INA700_ADC_CONVERSION_TIME_50				0x00
#define INA700_ADC_CONVERSION_TIME_84				0x01
#define INA700_ADC_CONVERSION_TIME_150				0x02
#define INA700_ADC_CONVERSION_TIME_280				0x03
#define INA700_ADC_CONVERSION_TIME_540				0x04
#define INA700_ADC_CONVERSION_TIME_1052				0x05
#define INA700_ADC_CONVERSION_TIME_2074				0x06
#define INA700_ADC_CONVERSION_TIME_4120				0x07

#define INA700_ADC_SAMPLE_AVG_COUNT_1				0x00
#define INA700_ADC_SAMPLE_AVG_COUNT_4				0x01
#define INA700_ADC_SAMPLE_AVG_COUNT_16				0x02
#define INA700_ADC_SAMPLE_AVG_COUNT_64				0x03
#define INA700_ADC_SAMPLE_AVG_COUNT_128				0x04
#define INA700_ADC_SAMPLE_AVG_COUNT_256				0x05
#define INA700_ADC_SAMPLE_AVG_COUNT_512				0x06
#define INA700_ADC_SAMPLE_AVG_COUNT_1024			0x07

#define IAN700_DIE_TEMPERATURE					GENMASK(15, 4)

#define INA700_ALERT_DIAG_LATCH_ENABLE				BIT(15)
#define INA700_ALERT_DIAG_CONVERSION_ALERT_ENABLE		BIT(14)
#define INA700_ALERT_DIAG_SLOW_ALERT_MODE			BIT(13)
#define INA700_ALERT_DIAG_ALERT_POLARITY			BIT(12)
#define INA700_ALERT_DIAG_ENERGY_OVERFLOW			BIT(11)
#define INA700_ALERT_DIAG_CHARGE_OVERFLOW			BIT(10)
#define INA700_ALERT_DIAG_MATH_OVERFLOW				BIT(9)
#define INA700_ALERT_DIAG_TEMPERATURE_OVER_LIMIT		BIT(7)
#define INA700_ALERT_DIAG_CURRENT_OVER_LIMIT			BIT(6)
#define INA700_ALERT_DIAG_CURRENT_UNDER_LIMIT			BIT(5)
#define INA700_ALERT_DIAG_BUS_OVER_LIMIT			BIT(4)
#define INA700_ALERT_DIAG_BUS_UNDER_LIMIT			BIT(3)
#define INA700_ALERT_DIAG_POWER_OVER_LIMIT			BIT(2)
#define INA700_ALERT_DIAG_CONVERSION_READY			BIT(1)
#define INA700_ALERT_DIAG_CHECKSUM_ERROR			BIT(0)

#define INA700_MANUFACTURER_ID					0x5449

#define INA700_CURRENT_LSB					480	/* uA */
#define INA700_VOLTAGE_LSB					3125	/* uV */
#define INA700_TEMPERATURE_LSB					125	/* mÂ°C */
#define INA700_POWER_LSB					96	/* uW */
#define INA700_ENERGY_LSB					1536	/* uJ */
#define INA700_CHARGE_LSB					30	/* uC */

#endif
