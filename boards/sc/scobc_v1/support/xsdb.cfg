# Copyright (c) 2025 Space Cubics Inc.
#
# SPDX-License-Identifier: Apache-2.0

proc program_pdi pdi_file {
	targets -set -filter {name =~ "Versal *"}
	after 300
	rst
	device program $pdi_file
}

proc rpu0_core0_rst {} {
	targets -set -filter {name =~ "Versal *"}
	after 300

	# Enable write to CRF by CRL.WPROT = 0
	mwr -force 0xff5e001c 0

	# Deassert CRL.POR, AMBA, RPU1, RPU0
	mwr -force 0xff5e0300 0
}

proc download_elf elf_file {
	targets -set -filter {name =~ "Cortex-R5 #0"}
	after 300
	stop
	after 1000

	# FIXME: Run TCC 1
	mwr -force 0xff5e0344 0

	dow -force $elf_file
	con

	# FIXME: Why do we need this?
	targets
}

proc load_image args  {
	if {[llength $args] != 2} {
		puts stderr "\nusage: west flash --pdi /path/to/your.pdi"
		puts stderr "For more details, do\n\twest flash --context -r xsdb\n"
	}

	set elf_file [lindex $args 0]
	set pdi_file [lindex $args 1]

	if { [info exists ::env(HW_SERVER_URL)] } {
		connect -url $::env(HW_SERVER_URL)
	} else {
		connect
	}

	program_pdi $pdi_file

	rpu0_core0_rst

	download_elf $elf_file

	exit
}

load_image {*}$argv
