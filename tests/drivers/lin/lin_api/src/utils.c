/*
 * Copyright (c) 2025 Renesas Electronics Corporation
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <zephyr/drivers/lin.h>
#include <zephyr/ztest.h>

#include "common.h"

/**
 * @addtogroup t_lin_driver
 * @{
 * @defgroup t_lin_utils test_lin_utils
 * @brief TestPurpose: verify LIN utility functions
 * @}
 */

ZTEST(lin_api_utils, test_lin_pid_calculate)
{
	/*
	 * Valid LIN IDs and their corresponding PIDs
	 *
	 * Reference: Table of Valid Frame Identifiers (Section 2.8.2) - LIN Specification Package
	 * Rev 2.2A
	 */

	const uint8_t valid_id[] = {
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C,
		0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
		0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26,
		0x27, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33,
		0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	};

	const uint8_t valid_pid[] = {
		0x80, 0xC1, 0x42, 0x03, 0xC4, 0x85, 0x06, 0x47, 0x08, 0x49, 0xCA, 0x8B, 0x4C,
		0x0D, 0x8E, 0xCF, 0x50, 0x11, 0x92, 0xD3, 0x14, 0x55, 0xD6, 0x97, 0xD8, 0x99,
		0x1A, 0x5B, 0x9C, 0xDD, 0x5E, 0x1F, 0x20, 0x61, 0xE2, 0xA3, 0x64, 0x25, 0xA6,
		0xE7, 0xA8, 0xE9, 0x6A, 0x2B, 0xEC, 0xAD, 0x2E, 0x6F, 0xF0, 0xB1, 0x32, 0x73,
		0xB4, 0xF5, 0x76, 0x37, 0x78, 0x39, 0xBA, 0xFB, 0x3C, 0x7D, 0xFE, 0xBF,
	};

	for (size_t i = 0; i < ARRAY_SIZE(valid_id); i++) {
		uint8_t computed_pid = lin_compute_pid(valid_id[i]);

		zassert_equal(computed_pid, valid_pid[i],
			      "lin_compute_pid failed for ID 0x%02X: expected 0x%02X, got 0x%02X",
			      valid_id[i], valid_pid[i], computed_pid);
	}

	for (size_t i = 0; i < ARRAY_SIZE(valid_pid); i++) {
		uint8_t computed_id = lin_get_frame_id(valid_pid[i]);

		zassert_equal(computed_id, valid_id[i],
			      "lin_get_frame_id failed for PID 0x%02X: expected 0x%02X, got 0x%02X",
			      valid_pid[i], valid_id[i], computed_id);
	}

	for (size_t i = 0; i < ARRAY_SIZE(valid_pid); i++) {
		bool is_valid = lin_verify_pid(valid_pid[i]);

		zassert_true(is_valid,
			     "lin_verify_pid failed for valid PID 0x%02X: expected true, got false",
			     valid_pid[i]);
	}
}

ZTEST(lin_api_utils, test_lin_transceiver)
{
	const struct device *phy = lin_get_transceiver(lin_commander);

	zassert_equal(phy, commander_phy, "wrong LIN transceiver device pointer returned");
}

ZTEST_SUITE(lin_api_utils, NULL, NULL, NULL, NULL, NULL);
